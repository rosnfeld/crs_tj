<script>
    var inclusionActions = {};
    var categoryActions = {};

    function getAllSelectedRowIDs() {
        var results = [];
        var selector = 'input:checkbox[id^="c_"]:checked';
        $(selector).each(function (index, item) {
            var checkbox_id = $(this).attr('id');
            var crs_pk = checkbox_id.substring(checkbox_id.lastIndexOf('_') + 1);
            results.push(crs_pk);
        });

        return results;
    }

    function applyInclusionToSelected(inclusion_id, inclusion_name) {
        var crs_pks = getAllSelectedRowIDs();
        for (var i = 0; i < crs_pks.length; i++) {
            var crs_pk = crs_pks[i];
            inclusionActions[crs_pk] = inclusion_id;

            var inclusion_text = $('#incl_' + crs_pk);
            inclusion_text.addClass('modified');
            inclusion_text.html(inclusion_name);

        }
    }

    function applyCategoryToSelected(category_id, category_name) {
        var crs_pks = getAllSelectedRowIDs();
        for (var i = 0; i < crs_pks.length; i++) {
            var crs_pk = crs_pks[i];
            categoryActions[crs_pk] = category_id;

            var category_text = $('#cat_' + crs_pk);
            category_text.addClass('modified');
            category_text.html(category_name);
        }
    }

    function commitActions() {
        $.ajax({
            url: "{% url 'query_commit_analysis' %}",

            type: "POST",

            data: JSON.stringify({inclusionActions: inclusionActions, categoryActions: categoryActions}),

            contentType: "application/json; charset=utf-8",

            success: refreshResults,

            error: function (xhr, status) {
                alert("Failed to commit analyzed rows");
            }
        });
    }
</script>
<div id="results_message" class="panel panel-default">
    <div class="panel-body">
    {% if rows.shape.0 < row_limit %}
        Returned {{ rows.shape.0 }} (all) results.
    {% else %}
        Returned the maximum limit of {{ row_limit }} results.
    {% endif %}
    </div>
</div>
<div id="results_controls" class="panel panel-default">
    <div class="panel-body">
        <div class="row">
            <div class="col-md-2">
                <input type='checkbox' id='check_all_none'/>
                <label for="all_none">Select All/None</label>
                <script>
                    $('#check_all_none').click(function () {
                        if ($(this).is(':checked')) {
                            $('.result_checkbox').prop("checked", true);
                        }
                        else {
                            $('.result_checkbox').removeAttr("checked");
                        }
                    });
                </script>
            </div>
            <div class="col-md-3">
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" id="drop_inclusion" data-toggle="dropdown">
                        Set Inclusion <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        {% for i, inclusion_row in inclusions.iterrows %}
                        <li><a onclick="applyInclusionToSelected('{{ inclusion_row.tj_inclusion_id }}', '{{ inclusion_row.tj_inclusion_name }}')">
                            {{ inclusion_row.tj_inclusion_name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-default dropdown-toggle" id="drop_category" data-toggle="dropdown">
                        Set Category <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        {% for i, category_row in categories.iterrows %}
                        <li><a onclick="applyCategoryToSelected('{{ category_row.tj_category_id }}', '{{ category_row.tj_category_name }}')">
                            {{category_row.tj_category_name|truncatechars:25 }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-default" type="button" onclick="commitActions()">
                    <span class="glyphicon glyphicon-floppy-save"></span>
                    Commit Analysis
                </button>
            </div>
        </div>
    </div>
</div>
<table id="results_table" class="table">
    <thead>
        <tr>
            <th>Select</th>
            <th>Include</th>
            <th>Category</th>
            <th>Year</th>
            <th>Recipient</th>
            <th>Donor</th>
            <th>Agency</th>
            <th>Channel</th>
            <th>USD Disbursed (millions of 2011 dollars)</th>
            <th>Sector</th>
            <th>Purpose</th>
            <th>Project Title</th>
            <th>Short Description</th>
            <th>Long Description</th>
        </tr>
    </thead>
    <tbody>
        {% for i, row in rows.iterrows %}
            <tr id="r_{{ i }}">
                <td><input type='checkbox' id='c_{{ i }}' class="result_checkbox"/></td>
                <td id="incl_{{ i }}">{{ row.tj_inclusion_name }}</td>
                <td id="cat_{{ i }}">{{ row.tj_category_name }}</td>
                <td>{{ row.year }}</td>
                <td>{{ row.recipientname }}</td>
                <td>{{ row.donorname }}</td>
                <td>{{ row.agencyname }}</td>
                <td>{{ row.channelname }}</td>
                <td>{{ row.usd_disbursement_defl | floatformat:6 }}</td>
                <td>{{ row.sectorname }}</td>
                <td>{{ row.purposename }}</td>
                <td>{{ row.projecttitle }}</td>
                <td>{{ row.shortdescription }}</td>
                <td>{{ row.longdescription }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
