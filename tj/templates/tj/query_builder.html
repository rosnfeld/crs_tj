<!DOCTYPE html>
<html>
<head>
    <title>Query Unanalyzed Data</title>
    {% include 'tj/header_includes.html' %}
    <script>
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            },
            timeout: 0  // in milliseconds, 0 means "don't time out"
        });

        function getSelectedCodesForFilter(filter_type) {
            var results = [];

            var selector = 'input:checkbox[id^="' + filter_type + '_"]:checked';
            $(selector).each(function (index, item) {
                var checkbox_id = $(this).attr('id');
                var code = checkbox_id.substring(checkbox_id.lastIndexOf('_') + 1);
                results.push(code);
            });

            return results;
        }

        function refreshResults() {
            // redo this as jQuery?
            var search_terms = document.getElementById('query_text').value;

            var code_filters = {};
            {% for filter_type in code_filter_types %}
            code_filters['{{ filter_type }}'] = getSelectedCodesForFilter('{{ filter_type }}');
            {% endfor %}

            $.ajax({
                url: "{% url 'query_results' %}",

                type: "POST",

                data: JSON.stringify({search_terms: search_terms, code_filters: code_filters}),

                contentType: "application/json; charset=utf-8",

                success: function (html) {
                    $("#results_holder").html(html);
                },

                error: function (xhr, status) {
                    alert("Failed to process query results");
                }
            });
        }

        function editFilter(filter_type) {
            $("#modal_filter_" + filter_type).modal();
        }

        $(document).ready(function() {
        });
    </script>
</head>
<body>
<div class="container">
    <ol class="breadcrumb">
        <li><a href="{% url 'home' %}">Home</a></li>
        <li class="active">Query Unanalyzed Data</li>
    </ol>
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="row">
                <label for="query_text" class="col-md-1">Query</label>
                <div class="col-md-7">
                    <input type="text" id="query_text" value="" class="form-control" placeholder="search terms">
                </div>
            </div>
            <div class="row top-buffer">
                <label class="col-md-1">Filters</label>
                <div class="col-md-8">
                    {% for filter_type in code_filter_types %}
                        <div class="btn-group">
                            <button type="button" class="btn btn-default dropdown-toggle" id="fb_{{ filter_type }}"
                                    onclick="editFilter('{{ filter_type }}')">
                                {{ filter_type|title }} <span class="caret"></span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
                <button class="btn btn-default" type="button" onclick="refreshResults()">
                    <span class="glyphicon glyphicon-search"></span>
                    Run Query
                </button>
            </div>
        </div>
    </div>
    <div id="results_holder"></div>
    <div id="modal_holder">
        {% include "tj/filter_modals.html" %}
    </div>
</div>
</body>
</html>
